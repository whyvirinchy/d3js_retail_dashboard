
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R.E.T.A.I.L. ANALYTICS 2000</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Roboto+Mono:wght@400;500&display=swap');

        :root {
            /* Professional Y2K Color Scheme */
            --bg-color: #121826;
            --panel-bg: #1E293B;
            --panel-border: #334155;
            --text-primary: #E2E8F0;
            --text-secondary: #94A3B8;
            --border-color: #475569;
            --border-highlight: #64748B;
            --shadow-color: #020617;
            --glow-color: rgba(0, 255, 255, 0.3);
            
            --font-header: 'Share Tech Mono', monospace;
            --font-body: 'Roboto Mono', monospace;

            /* Accent Colors */
            --color-accent-blue: #38BDF8;
            --color-accent-pink: #EC4899;
            --color-accent-green: #34D399;
            --color-accent-purple: #A78BFA;
            --positive-color: #38BDF8;
            --negative-color: #EC4899;
            --info-color: #60A5FA;
        }
        
        body[data-theme="light"] {
            --bg-color: #F8FAFC;
            --panel-bg: #FFFFFF;
            --panel-border: #E2E8F0;
            --text-primary: #1E293B;
            --text-secondary: #64748B;
            --border-color: #CBD5E1;
            --border-highlight: #94A3B8;
            --shadow-color: #F1F5F9;
            --glow-color: rgba(0, 180, 255, 0.2);

            /* Light Mode Accents */
            --color-accent-blue: #0284C7;
            --color-accent-pink: #DB2777;
            --color-accent-green: #059669;
        }

        body {
            font-family: var(--font-body);
            font-size: 14px;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            line-height: 1.5;
        }

        .main-container { 
            max-width: 1400px; 
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .dashboard-header {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            flex-wrap: wrap; 
            gap: 20px; 
            margin-bottom: 25px; 
            padding: 20px;
            border-radius: 8px;
            background-color: var(--panel-bg);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--panel-border);
        }
        
        .main-title { 
            margin: 0; 
            font-family: var(--font-header); 
            font-size: 20px; 
            color: var(--color-accent-blue); 
            letter-spacing: 0.05em;
        }
        
        .controls-wrapper { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        
        /* --- Professional Button Styles --- */
        .y2k-btn {
            font-family: var(--font-header); 
            font-size: 12px;
            background-color: var(--panel-bg); 
            border: 1px solid var(--border-color);
            padding: 8px 16px; 
            color: var(--text-primary);
            cursor: pointer; 
            transition: all 0.2s ease;
            border-radius: 4px;
            letter-spacing: 0.05em;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .y2k-btn:hover {
            background-color: var(--border-color);
            border-color: var(--border-highlight);
        }
        
        .y2k-btn:active { 
            transform: translateY(1px);
            box-shadow: none;
        }
        
        .y2k-btn.active { 
            background-color: var(--color-accent-blue); 
            color: #fff; 
            border-color: var(--color-accent-blue);
        }
        
        .theme-toggle-btn { 
            width: 40px; 
            height: 40px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            border-radius: 4px;
        }
        
        /* --- Welcome / Error Screens --- */
        .center-screen {
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            flex: 1;
            text-align: center;
        }
        
        .screen-panel {
            max-width: 800px; 
            padding: 40px; 
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0; 
            animation: fadeIn 0.8s 0.2s ease-out forwards;
        }
        
        .screen-panel h1 { 
            font-family: var(--font-header); 
            font-size: 24px; 
            color: var(--color-accent-blue); 
            margin-bottom: 15px; 
            letter-spacing: 0.05em;
        }
        
        .screen-panel .subtitle { 
            font-size: 16px; 
            color: var(--text-secondary); 
            max-width: 600px; 
            margin: 0 auto 30px auto; 
            line-height: 1.6; 
        }
        
        .features-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 20px; 
            margin-bottom: 30px; 
            text-align: left; 
        }
        
        .feature-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        
        .feature-item h3 { 
            font-family: var(--font-header); 
            font-size: 14px; 
            color: var(--color-accent-blue); 
            margin-bottom: 10px; 
            letter-spacing: 0.05em;
        }
        
        .feature-item p { 
            font-size: 14px; 
            color: var(--text-secondary); 
            line-height: 1.5; 
        }
        
        .upload-cta p { 
            font-size: 13px; 
            color: var(--text-secondary); 
            margin-top: 20px; 
        }
        
        .upload-cta code { 
            background-color: var(--panel-bg); 
            border: 1px solid var(--border-color); 
            padding: 2px 6px; 
            font-size: 0.9em; 
            border-radius: 3px;
            font-family: var(--font-body);
        }
        
        /* --- Error State --- */
        .error-panel { 
            background-color: rgba(239, 68, 68, 0.1); 
            color: #FECACA; 
            border: 1px solid #F87171; 
            text-align: left;
        }
        
        .error-panel h1 { 
            font-family: var(--font-header); 
            font-size: 20px; 
            color: #FECACA; 
            margin-bottom: 15px;
        }
        
        .error-panel p { 
            font-family: var(--font-body); 
            font-size: 14px; 
            color: var(--text-secondary); 
            margin-bottom: 10px;
        }
        
        .error-panel code { 
            color: #34D399; 
            background: rgba(20, 83, 45, 0.3); 
            padding: 2px 5px; 
            border-radius: 3px;
            font-family: var(--font-body);
        }
        
        /* --- Dashboard Layout --- */
        #content-container.dashboard {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: auto auto;
            gap: 20px;
            grid-template-areas:
                "line line line line bar bar"
                "scatter scatter donut donut heatmap heatmap";
            flex: 1;
        }
        
        .chart-panel {
            background: var(--panel-bg); 
            padding: 20px;
            border: 1px solid var(--panel-border);
            border-radius: 8px;
            position: relative;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            opacity: 0; 
            animation: fadeIn 0.5s forwards;
            display: flex;
            flex-direction: column;
        }
        
        .chart-panel:nth-child(1) { grid-area: line; animation-delay: 0.1s; }
        .chart-panel:nth-child(2) { grid-area: bar; animation-delay: 0.2s; }
        .chart-panel:nth-child(3) { grid-area: scatter; animation-delay: 0.3s; }
        .chart-panel:nth-child(4) { grid-area: donut; animation-delay: 0.4s; }
        .chart-panel:nth-child(5) { grid-area: heatmap; animation-delay: 0.5s; }

        .panel-title { 
            font-family: var(--font-header); 
            font-size: 14px; 
            margin-bottom: 20px; 
            color: var(--color-accent-blue); 
            padding-bottom: 10px; 
            border-bottom: 1px solid var(--border-color);
            letter-spacing: 0.05em;
        }
        
        .chart-container {
            flex: 1;
            min-height: 300px;
        }
        
        /* --- CRT Scanlines Effect --- */
        .crt-effect::after {
            content: " "; 
            display: block; 
            position: absolute; 
            top: 0; 
            left: 0; 
            bottom: 0; 
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.05) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02));
            background-size: 100% 2px, 3px 100%;
            z-index: 2; 
            pointer-events: none; 
            opacity: 0; 
            transition: opacity 0.3s ease;
            border-radius: 8px;
        }
        
        .chart-panel:hover .crt-effect::after { opacity: 0.5; }

        /* --- Tooltip Styles --- */
        .tooltip {
            position: absolute; 
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            padding: 10px 15px; 
            pointer-events: none;
            font-size: 13px; 
            line-height: 1.6; 
            opacity: 0;
            transition: opacity 0.2s ease;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 100;
            max-width: 250px;
        }
        
        .tooltip.visible { opacity: 1; }
        
        .tooltip-value { 
            font-weight: 500; 
            color: var(--color-accent-blue); 
        }
        
        /* --- Chart-Specific Styles --- */
        .axis path, .axis line { 
            stroke: var(--border-color); 
            shape-rendering: crispEdges; 
        }
        
        .axis text { 
            fill: var(--text-secondary); 
            font-family: var(--font-body); 
            font-size: 12px; 
        }
        
        .grid line { 
            stroke: var(--border-color); 
            stroke-opacity: 0.3; 
            stroke-dasharray: 2,4; 
        }
        
        .line-path { 
            stroke-width: 2; 
            fill: none; 
        }
        
        .line-daily-sales { 
            stroke: var(--color-accent-blue); 
        }
        
        .line-industry-average { 
            stroke: var(--color-accent-pink); 
            stroke-dasharray: 4,4; 
        }
        
        .bar { 
            transition: all 0.3s ease; 
        }
        
        .scatter-dot { 
            stroke: var(--bg-color); 
            stroke-width: 1px; 
            transition: r 0.2s ease, opacity 0.2s ease; 
        }
        
        .radar-grid-line { 
            stroke: var(--border-color); 
            stroke-opacity: 0.5; 
        }
        
        .donut-arc path { 
            stroke: var(--bg-color); 
            stroke-width: 2px; 
        }
        
        .heatmap-cell { 
            stroke: var(--bg-color); 
            stroke-width: 1px; 
            transition: opacity 0.2s ease; 
        }
        
        /* --- Store Selector --- */
        .store-selector {
            position: relative;
            min-width: 200px;
        }
        
        #store-select {
            width: 100%;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            font-family: var(--font-body);
            font-size: 13px;
            padding: 8px 12px;
            color: var(--text-primary);
            border-radius: 4px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394A3B8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
        }
        
        #store-select:focus {
            outline: none;
            border-color: var(--color-accent-blue);
            box-shadow: 0 0 0 1px var(--color-accent-blue);
        }
        
        /* --- Time Filter Buttons --- */
        .time-filters {
            display: flex;
            gap: 8px;
        }
        
        .time-filter-btn {
            min-width: 60px;
            text-align: center;
        }
        
        /* --- Animations --- */
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        /* --- Responsive Adjustments --- */
        @media (max-width: 1200px) {
            #content-container.dashboard {
                grid-template-columns: 1fr 1fr;
                grid-template-areas:
                    "line line"
                    "bar bar"
                    "scatter donut"
                    "heatmap heatmap";
            }
        }
        
        @media (max-width: 768px) {
            #content-container.dashboard {
                grid-template-columns: 1fr;
                grid-template-areas:
                    "line"
                    "bar"
                    "scatter"
                    "donut"
                    "heatmap";
            }
            
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .controls-wrapper {
                width: 100%;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .store-selector, .time-filters {
                width: 100%;
            }
            
            .time-filters {
                justify-content: space-between;
            }
            
            .time-filter-btn {
                flex: 1;
            }
        }
    </style>
</head>
<body data-theme="dark">

    <div class="main-container">
        <header class="dashboard-header">
            <h1 class="main-title">R.E.T.A.I.L. ANALYTICS 2000</h1>
            <div class="controls-wrapper" id="main-controls" style="display: none;">
                <div class="store-selector">
                    <select id="store-select"></select>
                </div>
                <div class="time-filters" id="time-filters">
                    <button class="y2k-btn time-filter-btn" data-period="y2k">Y2K</button>
                    <button class="y2k-btn time-filter-btn" data-period="y1k">Y1K</button>
                    <button class="y2k-btn time-filter-btn" data-period="y0k">Y0K</button>
                </div>
            </div>
            <div class="controls-wrapper">
                <button class="y2k-btn" id="upload-btn">UPLOAD DATA</button>
                <input type="file" id="csv-upload" accept=".csv" style="display: none;">
                <button class="y2k-btn theme-toggle-btn" id="theme-toggle" title="Toggle Theme">
                    <span>‚òÄÔ∏è</span>
                </button>
            </div>
        </header>
        <div id="content-container"></div>
    </div>
    
    <svg style="position:absolute; width:0; height:0;">
        <defs>
            <filter id="y2k-glitch">
                <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="1" result="turbulence" />
                <feDisplacementMap in="SourceGraphic" in2="turbulence" scale="3" xChannelSelector="R" yChannelSelector="G" />
            </filter>
        </defs>
    </svg>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Global Selections & Configuration ---
            const contentContainer = d3.select("#content-container");
            const mainControls = d3.select("#main-controls");
            const uploadBtn = d3.select("#upload-btn");
            const fileInput = d3.select("#csv-upload");
            const themeToggle = d3.select("#theme-toggle");
            const body = d3.select("body");

            const parseDate = (dateString) => {
                if (!dateString) return null;
                const formats = [
                    d3.timeParse("%Y-%m-%d"), d3.timeParse("%m/%d/%Y"),
                    d3.timeParse("%d-%m-%Y"), d3.timeParse("%b %d, %Y")
                ];
                for (const format of formats) {
                    const parsed = format(dateString);
                    if (parsed) return parsed;
                }
                return null;
            };
            
            const formatDate = d3.timeFormat("%b %d, '%y");
            const formatCurrency = (d) => `‚Çπ${d3.format(",.0f")(d)}`;
            
            const tooltip = d3.select("body").append("div").attr("class", "tooltip");
            let currentTheme = 'dark';
            let rawData = [];
            let currentStore, currentPeriod;

            // IMPORTANT: Your CSV file must contain these exact column headers.
            // The matching is case-insensitive and ignores spaces, but the names must be present.
            const REQUIRED_COLUMNS = [
                'Store', 'Date', 'DailySales', 'Industry Average', 'Global Average', 
                'Units Sold', 'Average Basket Size', 'Number of Transactions', 'Foot Traffic', 
                'Conversion Rate (%)', 'Gross Margin (%)', 'Net Profit', 'Inventory Available', 
                'Stockout Flag', 'Customer Satisfaction Score', 'Promotion Active'
            ];

            function processData(data) {
                if (data.length === 0) {
                    displayError("EMPTY FILE", "The uploaded CSV contains no data.");
                    return;
                }
                
                const findColumn = (colName) => {
                    return data.columns.find(c => 
                        c.trim().replace(/\s+/g, '').toLowerCase() === 
                        colName.replace(/\s+/g, '').toLowerCase());
                };

                const missingCols = REQUIRED_COLUMNS.filter(col => !findColumn(col));
                
                if (missingCols.length > 0) {
                    displayError("INVALID CSV FORMAT", `Missing required columns: ${missingCols.join(', ')}`);
                    return;
                }

                rawData = data.map((d, i) => {
                    const cleanRow = {};
                    REQUIRED_COLUMNS.forEach(col => {
                        const dataCol = findColumn(col);
                        if (!dataCol) return;
                        
                        const key = col; // Use the name from REQUIRED_COLUMNS as the key
                        const value = d[dataCol];

                        if (key === 'Date') {
                            const dateVal = parseDate(value);
                            if (!dateVal) console.warn(`Invalid date at row ${i+1}: ${value}`);
                            cleanRow[key] = dateVal;
                        } else if (key === 'Promotion Active' || key === 'Stockout Flag') {
                            cleanRow[key] = value === 'TRUE' || value === 'true' || value === '1';
                        } else if (key !== 'Store') {
                            const numVal = String(value).replace(/[^0-9.-]/g, '');
                            cleanRow[key] = (numVal === '' || isNaN(numVal)) ? 0 : +numVal;
                        } else {
                            cleanRow[key] = value;
                        }
                    });
                    return cleanRow;
                }).filter(d => d.Date instanceof Date && !isNaN(d.Date));
                
                if (rawData.length === 0) {
                    displayError("NO VALID DATA", "No rows with valid dates were found.");
                    return;
                }
                
                rawData.sort((a,b) => a.Date - b.Date);
                setupDashboard(rawData);
            }

            function setupDashboard(data) {
                mainControls.style("display", "flex");
                
                const stores = [...new Set(data.map(d => d.Store))].sort();
                const storeSelect = d3.select("#store-select");

                storeSelect.selectAll("option").data(stores).join("option")
                    .attr("value", d => d).text(d => d);
                
                currentStore = stores[0];
                
                const latestYear = d3.max(data, d => d.Date.getFullYear());
                d3.selectAll(".time-filter-btn").classed("active", false);
                d3.select(`.time-filter-btn[data-period='y2k']`).classed("active", true);
                currentPeriod = { type: 'year', value: latestYear };

                storeSelect.on("change", function() {
                    currentStore = d3.select(this).property("value");
                    renderDashboard(data, currentStore, currentPeriod);
                });

                d3.selectAll(".time-filter-btn").on("click", function() {
                    const periodType = d3.select(this).attr('data-period');
                    d3.selectAll(".time-filter-btn").classed("active", false);
                    d3.select(this).classed("active", true);
                    const latestYear = d3.max(data, d => d.Date.getFullYear());
                    if (periodType === 'y2k') currentPeriod = { type: 'year', value: latestYear };
                    else if (periodType === 'y1k') currentPeriod = { type: 'year', value: latestYear - 1 };
                    else if (periodType === 'y0k') currentPeriod = { type: 'year', value: latestYear - 2 };
                    renderDashboard(data, currentStore, currentPeriod);
                });

                renderDashboard(data, currentStore, currentPeriod);
            }

            function filterData(data, store, period) {
                return data.filter(d => {
                    const storeMatch = d.Store === store;
                    if (!storeMatch) return false;
                    const date = d.Date;
                    if (!date || !(date instanceof Date)) return false;
                    if (period.type === 'year') return date.getFullYear() === period.value;
                    return true;
                });
            }

            function renderDashboard(data, store, period) {
                contentContainer.html("").attr('class', 'dashboard');
                const filteredData = filterData(data, store, period);
                
                if(filteredData.length === 0) {
                     displayError("NO DATA FOR PERIOD", `Store ${store} has no data for the year ${period.value}.`);
                     return;
                }
                
                renderLineChart(filteredData, store);
                renderBarChart(filteredData, store);
                renderScatterPlot(filteredData, store);
                renderDonutChart(filteredData, store);
                renderHeatmap(filteredData, store);
            }

            function renderLineChart(data) {
                const container = contentContainer.append("div").attr("class", "chart-panel");
                container.html(`<h2 class="panel-title">SALES PERFORMANCE VS BENCHMARKS</h2><div class="chart-container crt-effect"></div>`);
                const chartContainer = container.select(".chart-container");
                const svg = chartContainer.append("svg").attr("viewBox", `0 0 1000 400`);
                const margin = {top: 20, right: 40, bottom: 50, left: 70}, width = 1000 - margin.left - margin.right, height = 400 - margin.top - margin.bottom;
                const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
                
                const yMax = d3.max(data, d => Math.max(d['DailySales'], d['Industry Average']));
                const x = d3.scaleTime().domain(d3.extent(data, d => d.Date)).range([0, width]);
                const y = d3.scaleLinear().domain([0, yMax * 1.1]).range([height, 0]).nice();
                
                g.append("g").attr("class", "grid").call(d3.axisLeft(y).ticks(5).tickSize(-width).tickFormat(""));
                g.append("g").attr("class", "axis y-axis").call(d3.axisLeft(y).ticks(5).tickFormat(d => `‚Çπ${d/1000}k`));
                g.append("g").attr("class", "axis x-axis").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x).ticks(d3.timeMonth.every(1)).tickFormat(d3.timeFormat("%b")));

                const lineConfig = {
                    "DailySales": { class: "line-daily-sales", filter: "url(#y2k-glitch)" },
                    "Industry Average": { class: "line-industry-average", filter: null }
                };

                for (const type in lineConfig) {
                    g.append("path")
                      .datum(data)
                      .attr("class", `line-path ${lineConfig[type].class}`)
                      .attr("d", d3.line().x(d => x(d.Date)).y(d => y(d[type])).curve(d3.curveMonotoneX))
                      .attr("filter", lineConfig[type].filter);
                }
                
                addHoverInteraction(g, width, height, data, x, y, (d) => `
                    <div style="font-weight:500;">${formatDate(d.Date)}</div>
                    <div><span style="color:var(--color-accent-blue)">‚ñ†</span> Sales: <strong class="tooltip-value">${formatCurrency(d['DailySales'])}</strong></div>
                    <div><span style="color:var(--color-accent-pink)">‚ñ†</span> Industry: <strong class="tooltip-value">${formatCurrency(d['Industry Average'])}</strong></div>
                    <div>Promotion: <strong class="tooltip-value">${d['Promotion Active'] ? "Active" : "Inactive"}</strong></div>
                `);
            }
            
            function renderBarChart(data) {
                const container = contentContainer.append("div").attr("class", "chart-panel");
                container.html(`<h2 class="panel-title">UNITS SOLD VS TRANSACTIONS</h2><div class="chart-container crt-effect"></div>`);
                const chartContainer = container.select(".chart-container");
                const svg = chartContainer.append("svg").attr("viewBox", `0 0 500 400`);
                const margin = {top: 20, right: 20, bottom: 50, left: 60}, width = 500 - margin.left - margin.right, height = 400 - margin.top - margin.bottom;
                const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
                
                const aggregatedData = d3.rollups(data, v => ({
                    'Units Sold': d3.sum(v, d => d['Units Sold']), 
                    'Number of Transactions': d3.sum(v, d => d['Number of Transactions'])
                }), d => d3.timeMonth(d.Date)).map(([key, value]) => ({date: key, ...value}));

                const x = d3.scaleBand().domain(aggregatedData.map(d => d.date)).range([0, width]).padding(0.4);
                const y = d3.scaleLinear().domain([0, d3.max(aggregatedData, d => Math.max(d['Units Sold'], d['Number of Transactions']))]).range([height, 0]).nice();
                
                const defs = svg.append("defs");
                const grad1 = defs.append("linearGradient").attr("id", "grad-bar-1").attr("x1", "0%").attr("y1", "100%").attr("x2", "0%").attr("y2", "0%");
                grad1.append("stop").attr("offset", "0%").style("stop-color", "var(--color-accent-blue)");
                grad1.append("stop").attr("offset", "100%").style("stop-color", "var(--color-accent-green)");
                const grad2 = defs.append("linearGradient").attr("id", "grad-bar-2").attr("x1", "0%").attr("y1", "100%").attr("x2", "0%").attr("y2", "0%");
                grad2.append("stop").attr("offset", "0%").style("stop-color", "var(--color-accent-pink)");
                grad2.append("stop").attr("offset", "100%").style("stop-color", "#ff66b2)");

                g.append("g").attr("class", "grid").call(d3.axisLeft(y).ticks(5).tickSize(-width).tickFormat(""));
                g.append("g").attr("class", "axis y-axis").call(d3.axisLeft(y).ticks(5));
                g.append("g").attr("class", "axis x-axis").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x).tickFormat(d3.timeFormat("%b")));

                g.selectAll(".bar-group").data(aggregatedData).join("g")
                    .attr("transform", d => `translate(${x(d.date)},0)`)
                    .each(function(d) {
                        d3.select(this).append("rect").attr("class", "bar").attr("x", 0).attr("y", height).attr("width", x.bandwidth() / 2).attr("height", 0)
                          .style("fill", "url(#grad-bar-1)").transition().duration(800).delay(200).attr("y", y(d['Units Sold'])).attr("height", height - y(d['Units Sold']));
                        d3.select(this).append("rect").attr("class", "bar").attr("x", x.bandwidth() / 2).attr("y", height).attr("width", x.bandwidth() / 2).attr("height", 0)
                          .style("fill", "url(#grad-bar-2)").transition().duration(800).delay(400).attr("y", y(d['Number of Transactions'])).attr("height", height - y(d['Number of Transactions']));
                    })
                    .on("mouseover", function(event, d) {
                        tooltip.classed("visible", true).html(`<strong>${d3.timeFormat("%B")(d.date)}</strong><br>Units: <span class="tooltip-value">${d3.format(",")(d['Units Sold'])}</span><br>Transactions: <span class="tooltip-value">${d3.format(",")(d['Number of Transactions'])}</span>`);
                        d3.select(this).selectAll('rect').style("opacity", 0.7);
                    })
                    .on("mousemove", (event) => tooltip.style("top", (event.pageY - 10) + "px").style("left", (event.pageX + 10) + "px"))
                    .on("mouseout", function() {
                        tooltip.classed("visible", false);
                        d3.select(this).selectAll('rect').style("opacity", 1);
                    });
            }

            function renderScatterPlot(data) {
                const container = contentContainer.append("div").attr("class", "chart-panel");
                container.html(`<h2 class="panel-title">FOOT TRAFFIC VS CONVERSION RATE</h2><div class="chart-container crt-effect"></div>`);
                const chartContainer = container.select(".chart-container");
                const svg = chartContainer.append("svg").attr("viewBox", `0 0 500 400`);
                const margin = {top: 20, right: 20, bottom: 50, left: 60}, width = 500 - margin.left - margin.right, height = 400 - margin.top - margin.bottom;
                const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
                
                const x = d3.scaleLinear().domain(d3.extent(data, d => d['Foot Traffic'])).range([0, width]).nice();
                const y = d3.scaleLinear().domain([0, d3.max(data, d => d['Conversion Rate (%)']) * 1.1]).range([height, 0]).nice();
                const color = d3.scaleOrdinal([`var(--color-accent-blue)`, `var(--color-accent-pink)`]).domain([true, false]);

                g.append("g").attr("class", "grid").call(d3.axisLeft(y).ticks(5).tickSize(-width).tickFormat(""));
                g.append("g").attr("class", "axis x-axis").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x).ticks(5));
                g.append("g").attr("class", "axis y-axis").call(d3.axisLeft(y).ticks(5).tickFormat(d => `${d}%`));

                g.selectAll(".scatter-dot").data(data).join("circle")
                    .attr("class", "scatter-dot")
                    .attr("cx", d => x(d['Foot Traffic'])).attr("cy", d => y(d['Conversion Rate (%)']))
                    .attr("r", 0).style("fill", d => color(d['Promotion Active'])).style("opacity", 0.7)
                    .on("mouseover", (event, d) => {
                        tooltip.classed("visible", true).html(`<strong>${formatDate(d.Date)}</strong><br>Traffic: <span class="tooltip-value">${d['Foot Traffic']}</span><br>Conversion: <span class="tooltip-value">${d['Conversion Rate (%)']}%</span><br>Promotion: <span class="tooltip-value">${d['Promotion Active'] ? 'Active' : 'Inactive'}</span>`);
                        d3.select(event.currentTarget).attr('r', 8).style('opacity', 1);
                    })
                    .on("mousemove", (event) => tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px"))
                    .on("mouseout", (event) => {
                        tooltip.classed("visible", false);
                        d3.select(event.currentTarget).attr('r', 5).style('opacity', 0.7);
                    })
                    .transition().duration(500).delay((d,i) => i * 2).attr("r", 5);
            }

            function renderDonutChart(data) {
                const container = contentContainer.append("div").attr("class", "chart-panel");
                container.html(`<h2 class="panel-title">PROMOTION ANALYSIS</h2><div class="chart-container crt-effect"></div>`);
                const chartContainer = container.select(".chart-container");
                const svg = chartContainer.append("svg").attr("viewBox", `0 0 500 400`);
                const margin = {top: 20, right: 20, bottom: 20, left: 20}, width = 500 - margin.left - margin.right, height = 400 - margin.top - margin.bottom;
                const radius = Math.min(width, height) / 2 - 20;
                const g = svg.append("g").attr("transform", `translate(${width / 2},${height / 2})`);
                
                const promotionData = d3.rollups(data, v => v.length, d => d['Promotion Active']);
                const pieData = Object.fromEntries(promotionData);
                const dataReady = [{key: 'Active', value: pieData[true] || 0}, {key: 'Inactive', value: pieData[false] || 0}];

                const color = d3.scaleOrdinal().domain(['Active', 'Inactive']).range([`var(--color-accent-blue)`, `var(--panel-border)`]);
                const pie = d3.pie().value(d => d.value).sort(null);
                const arc = d3.arc().innerRadius(radius * 0.6).outerRadius(radius);

                g.selectAll('.donut-arc').data(pie(dataReady)).join('g').attr('class', 'donut-arc')
                    .append('path').attr('d', arc).attr('fill', d => color(d.data.key))
                    .on("mouseover", (event, d) => {
                        tooltip.classed("visible", true).html(`<strong>${d.data.key} Days</strong><br>Count: <span class="tooltip-value">${d.data.value}</span>`);
                        d3.select(event.currentTarget).transition().duration(200).attr('d', d3.arc().innerRadius(radius * 0.65).outerRadius(radius * 1.05));
                    })
                    .on("mousemove", (event) => tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px"))
                    .on("mouseout", (event) => {
                        tooltip.classed("visible", false);
                        d3.select(event.currentTarget).transition().duration(200).attr('d', arc);
                    })
                    .transition().duration(800).attrTween('d', function(d) {
                        const i = d3.interpolate({startAngle: 0, endAngle: 0}, d);
                        return (t) => arc(i(t));
                    });

                const totalDays = d3.sum(dataReady, d => d.value);
                const activePercentage = totalDays > 0 ? (pieData[true] || 0) / totalDays : 0;
                
                g.append("text").attr("text-anchor", "middle").attr("dy", "-0.5em").style("font-size", "2.5em").style("font-family", "var(--font-header)").style("fill", "var(--color-accent-blue)").text(`${d3.format(".0%")(activePercentage)}`);
                g.append("text").attr("text-anchor", "middle").attr("dy", "1.2em").style("font-size", "0.9em").style("fill", "var(--text-secondary)").text("Promotions Active");
            }

            function renderHeatmap(data) {
                const container = contentContainer.append("div").attr("class", "chart-panel");
                container.html(`<h2 class="panel-title">DAILY SALES HEATMAP</h2><div class="chart-container crt-effect"></div>`);
                const chartContainer = container.select(".chart-container");
                const svg = chartContainer.append("svg").attr("viewBox", `0 0 500 400`);
                const margin = {top: 20, right: 20, bottom: 50, left: 60}, width = 500 - margin.left - margin.right, height = 400 - margin.top - margin.bottom;
                const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

                data.forEach(d => {
                    d.dayOfWeek = d3.timeFormat('%w')(d.Date); // Sunday = 0
                    d.weekOfMonth = Math.ceil(d.Date.getDate() / 7);
                });
                
                const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
                const weeks = [...new Set(data.map(d => d.weekOfMonth))].sort((a,b) => a-b);

                const x = d3.scaleBand().range([0, width]).domain(days).padding(0.05);
                const y = d3.scaleBand().range([height, 0]).domain(weeks).padding(0.05);
                const salesExtent = d3.extent(data, d => d['DailySales']);
                const color = d3.scaleSequential(d3.interpolateViridis).domain(salesExtent);

                g.append("g").attr("class", "axis x-axis").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x));
                g.append("g").attr("class", "axis y-axis").call(d3.axisLeft(y).tickFormat(d => `Wk ${d}`));

                g.selectAll(".heatmap-cell").data(data, d => d.Date).join("rect")
                    .attr("class", "heatmap-cell")
                    .attr("x", d => x(days[d.dayOfWeek])).attr("y", d => y(d.weekOfMonth))
                    .attr("width", x.bandwidth()).attr("height", y.bandwidth())
                    .style("fill", "var(--panel-bg)")
                    .on("mouseover", (event, d) => {
                        tooltip.classed("visible", true).html(`<strong>${formatDate(d.Date)}</strong><br>Sales: <span class="tooltip-value">${formatCurrency(d['DailySales'])}</span>`);
                        d3.select(event.currentTarget).style("stroke", "var(--color-accent-blue)").style("stroke-width", 2);
                    })
                    .on("mousemove", (event) => tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px"))
                    .on("mouseout", (event) => {
                        tooltip.classed("visible", false);
                        d3.select(event.currentTarget).style("stroke", "none");
                    })
                    .transition().duration(500).style("fill", d => salesExtent[0] === salesExtent[1] ? 'var(--color-accent-blue)' : color(d['DailySales']));
            }

            function addHoverInteraction(g, width, height, data, xScale, yScale, tooltipContentFn) {
                const hoverLine = g.append("line").attr("class", "hover-line").attr("y1", 0).attr("y2", height).attr("stroke", "var(--border-highlight)").attr("stroke-width", 1).attr("stroke-dasharray", "3,3").style("opacity", 0);
                const hoverDotsG = g.append("g");
                const bisect = d3.bisector(d => d.Date).left;

                g.append("rect").attr("class", "overlay").attr("width", width).attr("height", height).style("fill", "none").style("pointer-events", "all")
                    .on("mouseover", () => {
                        tooltip.classed("visible", true);
                        hoverLine.style("opacity", 1);
                        hoverDotsG.style("opacity", 1);
                    })
                    .on("mouseout", () => {
                        tooltip.classed("visible", false);
                        hoverLine.style("opacity", 0);
                        hoverDotsG.style("opacity", 0);
                    })
                    .on("mousemove", (event) => {
                        const [xPos] = d3.pointer(event, g.node());
                        const date = xScale.invert(xPos);
                        const index = bisect(data, date, 1);
                        const d0 = data[index - 1], d1 = data[index];
                        const d = (d1 && date - d0.Date > d1.Date - date) ? d1 : d0;

                        if (d) {
                            hoverLine.attr("x1", xScale(d.Date)).attr("x2", xScale(d.Date));
                            
                            hoverDotsG.selectAll("circle").data(["DailySales", "Industry Average"]).join("circle")
                                .attr("cx", xScale(d.Date))
                                .attr("cy", type => yScale(d[type]))
                                .attr("r", 5)
                                .attr("fill", type => type === "DailySales" ? "var(--color-accent-blue)" : "var(--color-accent-pink)");
                            
                            tooltip.html(tooltipContentFn(d)).style("left", (event.pageX + 15) + "px").style("top", (event.pageY - 30) + "px");
                        }
                    });
            }

            function displayWelcomeScreen() {
                contentContainer.html("").attr('class', 'center-screen');
                const panel = contentContainer.append('div').attr('class', 'screen-panel');
                panel.html(`
                    <h1>WELCOME TO RETAIL ANALYTICS 2000</h1>
                    <p class="subtitle">Your Y2K-era solution for modern retail data analysis. To begin, please upload a CSV file with your sales data.</p>
                    <div class="features-grid">
                        <div class="feature-item"><h3>MULTI-DIMENSIONAL ANALYSIS</h3><p>Track sales, transactions, foot traffic, and more against industry benchmarks.</p></div>
                        <div class="feature-item"><h3>DATA-DRIVEN INSIGHTS</h3><p>Utilize interactive charts to identify trends and opportunities for growth.</p></div>
                        <div class="feature-item"><h3>STORE-LEVEL GRANULARITY</h3><p>Filter data by specific store locations and time periods for detailed evaluation.</p></div>
                        <div class="feature-item"><h3>Y2K COMPLIANT</h3><p>Built with robust, forward-thinking technology, ready for the new millennium.</p></div>
                    </div>
                    <div class="upload-cta">
                        <button class="y2k-btn" id="welcome-upload-btn">UPLOAD .CSV DATA</button>
                        <p>Ensure your CSV has the required columns, like <code>Store</code>, <code>Date</code>, and <code>DailySales</code>.</p>
                    </div>
                `);
                d3.select("#welcome-upload-btn").on('click', () => fileInput.node().click());
            }

            function displayError(title, message) {
                contentContainer.html("").attr('class', 'center-screen');
                const panel = contentContainer.append('div').attr('class', 'screen-panel error-panel');
                panel.html(`<h1>SYSTEM ERROR: ${title}</h1><p>A problem was detected while processing your request. Please check the details below.</p><code>${message}</code><br><br><button class="y2k-btn" id="error-upload-btn">TRY UPLOAD AGAIN</button>`);
                d3.select("#error-upload-btn").on('click', () => fileInput.node().click());
            }

            uploadBtn.on('click', () => fileInput.node().click());
            fileInput.on('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    d3.csv(URL.createObjectURL(file)).then(processData).catch(err => {
                        displayError("FILE READ ERROR", "Could not read or parse the selected file.");
                        console.error(err);
                    });
                    event.target.value = null; // Reset file input
                }
            });
            themeToggle.on('click', () => {
                currentTheme = (currentTheme === 'dark') ? 'light' : 'dark';
                body.attr('data-theme', currentTheme);
                themeToggle.select('span').text(currentTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô');
                if (rawData.length > 0) renderDashboard(rawData, currentStore, currentPeriod);
            });

            displayWelcomeScreen();
        });
    </script>

</body>
</html>
```